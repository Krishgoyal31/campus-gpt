<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just LPU Things - Your Unified Academic Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Rockfall AI Dark Theme Variables (Default) --- */
        :root {
            --bg-color: #0D1117; /* Deep Dark Background */
            --primary-color: #161B22; /* Primary background for elements (cards, inputs) */
            --secondary-color: #010409; /* Deepest dark for contrast */
            --accent-color: #007BFF; /* Main Brand Blue */
            --glow-color: rgba(0, 123, 255, 0.5); /* Blue Glow */
            --text-primary: #E6EDF3;
            --text-secondary: #8B949E;
            --card-bg: rgba(22, 27, 34, 0.8); /* Semi-transparent card background */
            --card-border: rgba(255, 255, 255, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --white: #E6EDF3;

            font-family: 'Inter', 'Poppins', sans-serif;
            font-synthesis: none;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-text-size-adjust: 100%;
        }

        /* --- Light Theme Variables --- */
        .light-theme {
            --bg-color: #F0F4F8; /* Light Background */
            --primary-color: #FFFFFF; /* Pure White Elements */
            --secondary-color: #E2E8F0; /* Off-White/Light Gray Contrast */
            --accent-color: #007BFF; /* Main Brand Blue */
            --glow-color: rgba(0, 123, 255, 0.2); /* Soft Blue Glow */
            --text-primary: #1A202C;
            --text-secondary: #718096;
            --card-bg: rgba(255, 255, 255, 0.95); /* Semi-transparent white card background */
            --card-border: rgba(0, 0, 0, 0.1);
            --white: #1A202C; /* Text color for buttons/accents */
        }

        /* Generic variable mapping for easier global style referencing */
        :root, .light-theme {
            --text: var(--text-primary);
            --border: var(--card-border);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Poppins', sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            color: var(--text);
            position: relative;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Theme-specific background glow/gradient */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            /* Dark Theme Gradient (Default) */
            background:
                radial-gradient(circle at 15% 25%, var(--glow-color) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(130, 90, 255, 0.4) 0%, transparent 40%);
            animation: background-pan 25s linear infinite;
        }

        .light-theme::before {
             /* Light Theme Gradient */
            background:
                radial-gradient(circle at 15% 25%, var(--glow-color) 0%, transparent 35%),
                radial-gradient(circle at 85% 75%, rgba(200, 220, 255, 0.5) 0%, transparent 35%);
             animation: background-pan 25s linear infinite;
        }

        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* --- Login Page --- */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--bg-color);
        }

        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(20px);
            width: 100%;
            max-width: 450px;
            animation: fadeIn 0.5s ease;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
        }

        .logo h1 {
            color: var(--accent-color);
            font-size: 3.5em;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -2px;
            text-shadow: 0 0 10px var(--glow-color);
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 1em;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-primary);
            transition: all 0.3s;
            font-family: 'Inter', 'Poppins', sans-serif;
            resize: vertical;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--glow-color);
        }

        /* --- Button Styling --- */
        .btn {
            width: 100%;
            background: linear-gradient(90deg, var(--accent-color), #0056b3);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
            padding: 16px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 123, 255, 0.5);
        }
        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent 40%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
        }
        .btn:hover:not(:disabled):before {
            transform: translate(-50%, -50%) scale(1);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .demo-credentials {
            margin-top: 25px;
            padding: 15px;
            background: var(--primary-color);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        /* --- Dashboard --- */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: flex;
        }

        /* --- Sidebar & Navigation --- */
        .sidebar {
            width: 260px;
            background: var(--primary-color);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            border-right: 1px solid var(--card-border);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, background 0.3s;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: var(--secondary-color);
            border-bottom: 1px solid var(--card-border);
            text-align: center;
            transition: background 0.3s;
        }

        .sidebar-header h2 {
            font-size: 2.0em;
            color: var(--accent-color);
            margin-bottom: 5px;
            font-weight: 800;
            text-shadow: 0 0 8px var(--glow-color);
            letter-spacing: -0.5px;
        }

        .sidebar-header p {
            font-size: 0.85em;
            opacity: 0.8;
            color: var(--text-secondary);
        }

        .nav-menu {
            list-style: none;
            padding: 20px 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .nav-item.filtered {
            display: none !important;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            font-weight: 500;
            border-radius: 10px;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(0, 123, 255, 0.1);
            color: var(--accent-color);
        }

        .nav-link.active {
            background: var(--accent-color);
            color: var(--white);
            font-weight: 600;
            border-right: none;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .nav-link.active .nav-icon {
            color: var(--white);
        }
        .light-theme .nav-link.active .nav-icon {
            color: var(--primary-color);
        }


        .new-chat-btn {
            background: var(--secondary-color);
            border: 1px dashed var(--card-border);
            color: var(--text-secondary);
            margin: 0 15px 15px 15px;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .new-chat-btn:hover {
            background: rgba(0, 123, 255, 0.1);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

         .nav-link#logoutBtn {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border-radius: 8px;
            justify-content: center;
            font-weight: 600;
            padding: 14px;
         }
         .nav-link#logoutBtn:hover {
            background: rgba(220, 53, 69, 0.2);
         }


        /* --- Main Content --- */
        .main-content {
            margin-left: 260px;
            padding: 20px;
            width: calc(100% - 260px);
            min-height: 100vh;
            overflow-y: auto;
        }

        .card-icon.blue { background: rgba(0, 123, 255, 0.1); color: var(--accent-color); }
        .card-icon.green { background: rgba(40, 167, 69, 0.1); color: var(--success); }
        .card-icon.orange { background: rgba(255, 193, 7, 0.1); color: var(--warning); }
        .card-icon.purple { background: rgba(220, 53, 69, 0.1); color: var(--danger); }

        /* [Additional existing styles for readability] */
        .top-bar {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: background 0.3s, border-color 0.3s;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background: var(--primary-color);
            padding: 8px 15px;
            border-radius: 8px;
            width: 300px;
            border: 1px solid var(--card-border);
            transition: background 0.3s, border-color 0.3s;
        }

        .search-bar input[type="text"] {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 0 0 10px;
            width: 100%;
            color: var(--text-primary);
        }

        .search-bar input[type="text"]:focus {
            outline: none;
            border-color: transparent;
            box-shadow: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Styling for the Theme Switcher and Notification Icons */
        .icon-button {
            position: relative;
            cursor: pointer;
            color: var(--text-primary);
            transition: color 0.3s, transform 0.2s;
            padding: 5px;
            border-radius: 50%;
        }
        .icon-button:hover {
             color: var(--accent-color);
             transform: scale(1.1);
        }

        .notification-icon {
            /* Kept for existing structure */
        }
        .theme-switcher-icon {
             /* New style */
        }


        .badge {
            position: absolute;
            top: 0px; /* Adjusted top position */
            right: 0px; /* Adjusted right position */
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }
        .page-content { display: none; }
        .page-content.active { display: block; animation: slideIn 0.4s ease-out; padding: 0; }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 2.2em; color: var(--text-primary); margin-bottom: 5px; }
        .page-header p { color: var(--text-secondary); }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); transition: all 0.4s ease; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 16px 45px 0 rgba(0, 0, 0, 0.4), 0 0 0 1px var(--accent-color); }
        .card-header { display: flex; align-items: center; margin-bottom: 15px; }
        .card-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; font-size: 24px; }
        .card-title { font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
        .card-value { font-size: 2.2em; font-weight: 700; color: var(--accent-color); margin-top: 5px; }
        .table-container { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary-color); padding: 15px; text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 0.9em; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--card-border); color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(0, 123, 255, 0.05); }
        .chat-container { height: calc(100vh - 220px); }
        .chat-box { background: var(--card-bg); border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); height: 100%; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; gap: 10px; max-width: 75%; animation: messageSlide 0.3s ease; }
        .message.bot { align-self: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600; }
        .message.bot .message-avatar { background: var(--secondary-color); color: var(--accent-color); border: 1px solid var(--accent-color); }
        .message.user .message-avatar { background: var(--accent-color); color: var(--primary-color); }
        .message-content { background: var(--primary-color); color: var(--text-primary); padding: 12px 16px; border-radius: 12px; white-space: pre-wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid var(--card-border); }
        .message.user .message-content { background: var(--accent-color); color: var(--primary-color); border-color: var(--accent-color); box-shadow: 0 2px 5px var(--glow-color); }
        .chat-input { padding: 20px; border-top: 1px solid var(--card-border); display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
        .chat-input input { flex: 1; padding: 12px 16px; border: 1px solid var(--card-border); background: var(--secondary-color); border-radius: 8px; font-size: 1em; color: var(--text-primary); }
        .chat-input input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--glow-color); }
        .chat-input button { background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; padding: 10px 15px; }
        .chat-input button:hover { background: #0056b3; }
        .doubt-solver-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: calc(100vh - 180px); }
        .doubt-form-card { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 20px; }
        .file-upload-status { display: flex; flex-direction: column; gap: 5px; padding: 10px; border: 1px solid var(--card-border); border-radius: 8px; background: var(--primary-color); font-size: 0.9em; color: var(--text-primary); }
        .file-status-info { border-color: var(--accent-color); background: rgba(0, 123, 255, 0.1); color: var(--accent-color); }
        .file-status-warning { border-color: var(--warning); background: rgba(255, 193, 7, 0.1); color: var(--warning); }
        .file-status-success { border-color: var(--success); background: rgba(40, 167, 69, 0.1); color: var(--success); }
        .file-status-image { border-color: var(--danger); background: rgba(220, 53, 69, 0.1); color: var(--danger); }
        .status-message { display: flex; align-items: flex-start; gap: 8px; font-weight: 600; }
        .status-file-name { font-weight: 500; color: var(--text-secondary); font-size: 0.85em; margin-top: 5px; }
        .doubt-response-box { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .doubt-response-header { padding: 15px 20px; border-bottom: 1px solid var(--card-border); font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 10px; background: var(--primary-color); border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .doubt-response-content { flex: 1; padding: 20px; overflow-y: auto; white-space: pre-wrap; font-size: 1em; line-height: 1.6; }
        .event-card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--accent-color); box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px); transition: all 0.3s; }
        .event-card:hover { transform: translateX(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        .notification-item { padding: 15px; border-bottom: 1px solid var(--card-border); transition: background 0.2s; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background: rgba(0, 123, 255, 0.05); border-left: 4px solid var(--accent-color); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); box-shadow: none; }
            .sidebar.mobile-open { transform: translateX(0); box-shadow: 2px 0 10px rgba(0,0,0,0.3); }
            .main-content { margin-left: 0; width: 100%; }
            .search-bar { width: 200px; }
            .doubt-solver-grid { grid-template-columns: 1fr; height: auto; }
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; gap: 15px; align-items: stretch; }
            .search-bar { width: 100%; }
            .chat-container { height: auto; min-height: 250px; }
        }
        .hidden { display: none !important; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--primary-color); color: var(--text-primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); border: 1px solid var(--card-border); opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.215, 0.610, 0.355, 1.000); display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .typing-indicator { display: flex; align-items: center; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: var(--accent-color); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .message.bot .message-content { background: var(--primary-color); color: var(--text); }
        .typing-indicator.bot-typing span { background-color: var(--accent-color); }
        .message.bot #typing-indicator .message-content { background: var(--primary-color); }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="logo">
                <h1 style="display: flex; align-items: center; justify-content: center;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="vertical-align: middle; margin-right: 5px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Just LPU Things
                </h1>
                <p>YOUR UNIFIED ACADEMIC ASSISTANT</p>
            </div>

            <form id="loginForm">
                 <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>

                <button type="submit" class="btn">Secure Login</button>
            </form>

            <div class="demo-credentials">
                <p><strong>Demo Credentials:</strong></p>
                <p><b>Student:</b> student@college.edu / student123</p>
                <p><b>Faculty:</b> faculty@college.edu / faculty123</p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="dashboard">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>LPU AI</h2>
                <p id="userNameDisplay">Welcome User</p>
            </div>

            <ul class="nav-menu" id="navMenu">
                <li class="nav-item"><a class="nav-link active" data-page="home"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>Dashboard</a></li>
                <li class="nav-item new-feature"><a class="nav-link" data-page="doubt-solver"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>AI Doubt Solver</a></li>
                <li class="nav-item"><a class="nav-link" data-page="chat"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 21H5a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4l2-2h4a2 2 0 012 2v12a2 2 0 01-2 2h-5L9 21z"></path></svg>AI Chat Assistant</a></li>
                <li class="nav-item"><a class="nav-link" data-page="timetable"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Timetable</a></li>

                <li class="nav-item"><a class="nav-link" data-page="exams"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>Exams & Grades</a></li>
                <li class="nav-item">
                    <a class="nav-link" data-page="assignments">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Pending Tasks <span class="badge" id="assignmentsBadge">0</span>
                    </a>
                </li>
                <li class="nav-item"><a class="nav-link" data-page="events"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Campus Events</a></li>
                <li class="nav-item"><a class="nav-link" data-page="faculty"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>Faculty Directory</a></li>
                <li class="nav-item hidden" id="adminNav"><a class="nav-link" data-page="admin"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>Admin Panel</a></li>
                <li class="nav-item"><a class="nav-link" data-page="notifications"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>Notifications <span class="badge" id="notifBadge">0</span></a></li>
            </ul>

            <div class="new-chat-btn" onclick="startNewChat()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: middle;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> New Chat
            </div>

             <div style="padding: 0 15px 20px;">
                <a class="nav-link" id="logoutBtn"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Logout</a>
             </div>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div class="search-bar">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--text-secondary);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="mainSearchBar" placeholder="Search Just LPU Things...">
                </div>

                <div class="user-info">
                    <div class="icon-button theme-switcher-icon" id="themeToggleBtn">
                         </div>

                    <div class="icon-button notification-icon" id="topNotifBtn">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <span class="badge" id="topNotifBadge">0</span>
                    </div>
                    <div class="user-avatar" id="userAvatar">JD</div>
                </div>
            </div>

            <div id="homePage" class="page-content active">
                <div class="page-header">
                    <h1 id="welcomeHeader">Welcome Back! üëã</h1>
                    <p>Here's what's happening on your campus today</p>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header"><div class="card-icon blue"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div><div class="card-title">Today's Classes</div></div></div><div class="card-value" id="todayClassesCount">0</div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div class="card-icon green"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div><div class="card-title" id="attendanceCardTitle">Attendance</div></div></div><div class="card-value" id="attendanceValue">--</div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div class="card-icon orange"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div><div class="card-title" id="assignmentsCardTitle">Pending Assignments</div></div></div><div class="card-value" id="assignmentsValue">--</div>
                    </div>
                     <div class="card">
                        <div class="card-header"><div class="card-icon purple"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div><div><div class="card-title">Upcoming Events</div></div></div><div class="card-value" id="upcomingEventsCount">0</div>
                    </div>
                </div>

                <div class="table-container">
                    <h2 style="margin-bottom: 20px;">Today's Schedule</h2>
                    <table id="todaySchedule">
                        <thead><tr><th>Time</th><th>Subject</th><th>Faculty</th><th>Room</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="doubt-solverPage" class="page-content">
                <div class="page-header"><h1>AI Doubt Solver üí°</h1><p>Upload a file or image to get context-specific analysis from the AI.</p></div>

                <div class="doubt-solver-grid">
                    <div class="doubt-form-card">
                        <form id="doubtSolverForm">
                            <div class="form-group">
                                <label for="documentUpload">Upload Document/Image (TXT, PDF, DOCX, JPG, PNG)</label>
                                <input type="file" id="documentUpload" accept=".txt, .pdf, .docx, .jpg, .jpeg, .png" required>
                            </div>

                            <div class="file-upload-status hidden" id="fileStatus">
                                <div class="status-message" id="statusMessage">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span>File Info</span>
                                </div>
                                <div class="status-file-name" id="fileName">No file selected.</div>
                            </div>

                            <div class="form-group">
                                <label for="userQuery">Your Specific Question/Prompt</label>
                                <input type="text" id="userQuery" placeholder="Summarize this document, or What is the main topic?" required>
                            </div>

                            <div class="form-group">
                                <label for="documentTextArea">Paste Document Text Here (REQUIRED for PDF/DOCX)</label>
                                <textarea id="documentTextArea" placeholder="Paste the full text of your PDF or DOCX file here, or leave empty if uploading a TXT or Image file." rows="8"></textarea>
                            </div>

                            <button type="submit" class="btn" id="solveDoubtBtn">Solve Doubt</button>
                        </form>
                    </div>

                    <div class="doubt-response-box">
                        <div class="doubt-response-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            AI Response
                        </div>
                        <div class="doubt-response-content" id="doubtResponseContent">
                            <p style="color: var(--text-secondary);">Upload a document and ask a question to get context-specific answers from the AI.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chatPage" class="page-content">
                <div class="page-header"><h1>AI Chat Assistant ü§ñ</h1><p>Ask me anything about your academics, schedule, or campus</p></div>
                <div class="chat-container">
                    <div class="chat-box">
                        <div class="chat-messages" id="chatMessages"><div class="message bot"><div class="message-avatar">AI</div><div class="message-content">Hello! I'm your Campus AI Assistant powered by Llama 3. How can I help you today?</div></div></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Type your message...">
                            <button id="sendBtn">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="timetablePage" class="page-content">
                <div class="page-header"><h1>Class Timetable üìÖ</h1><p>Your weekly schedule at a glance</p></div>
                <div class="table-container"><table id="timetableTable"><thead><tr><th>Day</th><th>Time</th><th>Subject</th><th>Faculty</th><th>Room</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="examsPage" class="page-content">
                <div class="page-header"><h1>Exam Schedule üìù</h1><p>Stay prepared for your upcoming exams</p></div>
                <div class="table-container"><table id="examsTable"><thead><tr><th>Subject</th><th>Date</th><th>Time</th><th>Room</th><th>Duration</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="assignmentsPage" class="page-content">
                <div class="page-header"><h1 id="assignmentsPageHeader">Pending Tasks üìö</h1><p id="assignmentsPageSubtitle">Your list of incomplete academic tasks and due dates</p></div>
                <div class="table-container">
                    <table id="assignmentsTable">
                        <thead>
                            <tr><th id="assignmentHeaderSubject">Subject</th><th id="assignmentHeaderTitle">Title</th><th>Due Date</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            <div id="eventsPage" class="page-content">
                <div class="page-header"><h1>Campus Events üéâ</h1><p>Don't miss out on exciting campus activities</p></div>
                <div id="eventsContainer"></div>
            </div>

            <div id="facultyPage" class="page-content">
                <div class="page-header"><h1>Faculty Directory üë®‚Äçüè´</h1><p>Contact information for your professors</p></div>
                <div class="table-container"><table id="facultyTable"><thead><tr><th>Name</th><th>Department</th><th>Email</th><th>Phone</th><th>Office</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="adminPage" class="page-content">
                <div class="page-header"><h1>Admin Dashboard üìä</h1><p>Manage campus communications and view analytics</p></div>
                <div class="cards-grid" id="analyticsGrid"> </div>
                <div style="background: var(--card-bg); border-radius: 16px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid var(--card-border); backdrop-filter: blur(10px);">
                    <h2 style="margin-bottom: 20px;">Post New Event</h2>
                    <form id="eventForm">
                        <div class="form-row"><div class="form-group"><label>Event Title</label><input type="text" id="eventTitle" placeholder="Enter event title" required></div><div class="form-group"><label>Event Date</label><input type="date" id="eventDate" required></div></div>
                        <div class="form-row"><div class="form-group"><label>Event Time</label><input type="time" id="eventTime" required></div><div class="form-group"><label>Location</label><input type="text" id="eventLocation" placeholder="Enter location" required></div></div>
                        <div class="form-group"><label>Description</label><input type="text" id="eventDescription" placeholder="Enter event description" required></div>
                        <button type="submit" class="btn" style="width: auto; min-width: 150px;">Post Event</button>
                    </form>
                </div>
            </div>

            <div id="notificationsPage" class="page-content">
                 <div class="page-header"><h1>Notifications üîî</h1><p>Stay updated with important announcements</p></div>
                 <div class="table-container" id="notificationsContainer"></div>
            </div>

        </div>
    </div>

    <script>
        // --- SVG Icons for Theme Toggle ---
        const moonIcon = `<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
        const sunIcon = `<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-theme');

            const isLight = body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');

            updateThemeIcon(isLight);
        }

        function updateThemeIcon(isLight) {
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            if (themeToggleBtn) {
                themeToggleBtn.innerHTML = isLight ? moonIcon : sunIcon;
            }
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
            const body = document.body;

            if (savedTheme === 'light') {
                body.classList.add('light-theme');
                updateThemeIcon(true);
            } else {
                body.classList.remove('light-theme');
                updateThemeIcon(false);
            }
        }

        function startNewChat() {
            // Clear all current messages
            document.getElementById('chatMessages').innerHTML = '<div class="message bot"><div class="message-avatar">AI</div><div class="message-content">Hello! I\'m your Campus AI Assistant powered by Llama 3. How can I help you today?</div></div>';
            navigateTo('chat');
            showToast('New AI Chat session started!', 'info');
        }

        function filterNavigation() {
            const searchInput = document.getElementById('mainSearchBar');
            if (!searchInput) return;

            const filter = searchInput.value.toUpperCase();
            const navMenu = document.getElementById('navMenu');
            const navItems = navMenu.getElementsByClassName('nav-item');

            for (let i = 0; i < navItems.length; i++) {
                const navLink = navItems[i].querySelector('.nav-link');
                const text = navLink ? navLink.textContent.toUpperCase() : '';

                // If the link text includes the search filter, or the filter is empty, show the item.
                if (text.indexOf(filter) > -1 || filter === '') {
                    navItems[i].classList.remove('filtered');
                } else {
                    navItems[i].classList.add('filtered');
                }
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
        // Apply theme immediately on load
        applySavedTheme();

        // --- Globals & Config ---
        const API_BASE = 'http://127.0.0.1:5000/api';
        // WARNING: The API Key below is for DEMO PURPOSES ONLY and is exposed on the client.
        // In a real application, you MUST proxy all calls to the Gemini API through your Flask backend to secure your key.
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=';
        const apiKey = "AIzaSyAgVb6kApTaE-PtbfJkmadwjojYKjT1BF8"; // Keep placeholder blank for canvas environment
        let currentUser = null;

        // --- Element Selectors ---
        const loginPage = document.getElementById('loginPage');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const doubtSolverForm = document.getElementById('doubtSolverForm');
        const documentUpload = document.getElementById('documentUpload');
        const fileNameSpan = document.getElementById('fileName');
        const fileStatusDiv = document.getElementById('fileStatus');
        const statusMessageSpan = document.getElementById('statusMessage');
        const documentTextArea = document.getElementById('documentTextArea');
        const userQueryInput = document.getElementById('userQuery');
        const doubtResponseContent = document.getElementById('doubtResponseContent');
        const mainSearchBar = document.getElementById('mainSearchBar');
        const topNotifBtn = document.getElementById('topNotifBtn');

        // Dashboard elements
        const attendanceValue = document.getElementById('attendanceValue');
        const assignmentsValue = document.getElementById('assignmentsValue');
        const assignmentsCardTitle = document.getElementById('assignmentsCardTitle');
        const attendanceCardTitle = document.getElementById('attendanceCardTitle');


        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.page)));

        // Theme Toggle Listener
        document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

        // Search Listener
        if (mainSearchBar) {
            mainSearchBar.addEventListener('keyup', filterNavigation);
        }

        // Notifications Icon Click Handler
        if (topNotifBtn) {
            topNotifBtn.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('notifications');
            });
        }

        // Chat Assistant Listeners
        document.getElementById('sendBtn').addEventListener('click', () => sendChatMessage());
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

        // Admin Event Post Listener
        document.getElementById('eventForm').addEventListener('submit', handleEventPost);

        // Doubt Solver Listeners
        doubtSolverForm.addEventListener('submit', handleDoubtSolverQuery);
        documentUpload.addEventListener('change', updateFileStatus);

        // --- Toast Notification ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const iconPath = type === 'success' ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : type === 'error' ? 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
            toast.innerHTML = `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path></svg><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- API Functions ---
        async function apiCall(endpoint, options = {}) {
            // Default options to ensure cookies are sent/received (CRITICAL for login)
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                },
                ...options
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, defaultOptions);

                // Check if response is okay (200-299 status)
                if (!response.ok) {
                    // Attempt to read error message from JSON body
                    const errorData = await response.json().catch(() => ({ message: `Server responded with status: ${response.status}` }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                const message = error.message.includes('HTTP error') ? 'A network error occurred or the backend is offline (Port 5000).' : error.message;
                showToast(`Error: ${message}`, 'error');
                throw error;
            }
        }

        // --- Authentication ---
        async function handleLogin(e) {
            e.preventDefault();
            const payload = {
                method: 'POST',
                body: JSON.stringify({ email: loginEmail.value, password: loginPassword.value })
            };
            try {
                const data = await apiCall('/login', payload);
                if (data.success) {
                    currentUser = data.user;
                    initDashboard();
                }
            } catch (error) { /* ... handled by apiCall */ }
        }

        async function handleLogout() {
            await apiCall('/logout', { method: 'POST' });
            currentUser = null;
            dashboard.classList.remove('active');
            loginPage.style.display = 'flex';
            // Manually clear fields to ensure a clean state
            loginEmail.value = '';
            loginPassword.value = '';
            showToast('Logged out successfully.', 'info');
        }

        // --- Dashboard Initialization ---
        function initDashboard() {
            loginPage.style.display = 'none';
            dashboard.classList.add('active');
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('welcomeHeader').textContent = `Welcome Back, ${currentUser.name.split(' ')[0]}! üëã`;
            const initials = currentUser.name.split(' ').map(n => n[0]).join('');
            document.getElementById('userAvatar').textContent = initials;

            if (currentUser.type === 'faculty') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else {
                 document.getElementById('adminNav').classList.add('hidden');
            }
            loadAllData();
            navigateTo('home');
        }

        function loadAllData() {
            loadDashboardMetrics();
            loadTimetable();
            loadExams();
            loadPendingAssignments(); // <-- NEW CALL
            loadEvents();
            loadFaculty();
            loadNotifications();
            if(currentUser && currentUser.type === 'faculty') loadAnalytics();
        }

        function navigateTo(page) {
            if (!page) return;

            document.querySelectorAll('.nav-link.active').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.page-content.active').forEach(p => p.classList.remove('active'));

            // Check if the clicked link is visible (not filtered) before activating it
            const targetLink = document.querySelector(`.nav-link[data-page="${page}"]`);
            if (targetLink && !targetLink.parentElement.classList.contains('filtered')) {
                targetLink.classList.add('active');
            }

            const targetPageElement = document.getElementById(`${page}Page`);
            if (targetPageElement) {
                targetPageElement.classList.add('active');
            }
        }

        // --- Dynamic Dashboard Metrics Loading (FETCHES USER-SPECIFIC DATA) ---
        async function loadDashboardMetrics() {
            try {
                const data = await apiCall('/dashboard-metrics');

                // Update Dashboard Card Titles based on user type
                if (currentUser.type === 'faculty') {
                    assignmentsCardTitle.textContent = 'Grading Load';
                    attendanceCardTitle.textContent = 'Workload Avg.';
                    attendanceValue.textContent = data.attendance || 'N/A'; // N/A should display
                } else {
                    assignmentsCardTitle.textContent = 'Pending Assignments';
                    attendanceCardTitle.textContent = 'Attendance';
                    attendanceValue.textContent = (data.attendance === 'N/A' || typeof data.attendance !== 'number')
                        ? data.attendance
                        : `${data.attendance}%`;
                }


                // Update Pending Assignments/Workload Card
                const pendingCount = data.pending_assignments;
                assignmentsValue.textContent = pendingCount;

                // Update sidebar badge with the same count
                const assignmentsBadge = document.getElementById('assignmentsBadge');
                if (assignmentsBadge) {
                    assignmentsBadge.textContent = pendingCount;
                }

            } catch (error) {
                console.error("Failed to load dashboard metrics:", error);
                // Set placeholders on failure
                attendanceValue.textContent = 'Err';
                assignmentsValue.textContent = 'Err';
            }
        }


        // --- Data Loading & Rendering (Receives filtered data from backend) ---
        async function loadTimetable() {
            // Backend filters this data based on logged-in user's courses
            const data = await apiCall('/timetable');
            const tbody = document.querySelector('#timetableTable tbody');
            const todayTbody = document.querySelector('#todaySchedule tbody');
            tbody.innerHTML = '';
            todayTbody.innerHTML = '';

            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            let todayClassesCount = 0;

            data.forEach(item => {
                // Ensure the subject is one the student is enrolled in or show all for faculty
                const isRelevant = !currentUser || currentUser.type === 'faculty' || (currentUser.courses && currentUser.courses.includes(item.subject));

                const rowHtml = `<td>${item.time}</td><td>${item.subject}</td><td>${item.faculty}</td><td>${item.room}</td>`;
                // Populate the full timetable table
                if (isRelevant) {
                   tbody.innerHTML += `<tr><td>${item.day}</td>${rowHtml}</tr>`;
                }

                // Populate the Today's Schedule (Dashboard)
                if (item.day === today && isRelevant) {
                    todayTbody.innerHTML += `<tr>${rowHtml}</tr>`;
                    todayClassesCount++;
                }
            });
            document.getElementById('todayClassesCount').textContent = todayClassesCount;
        }

        // FUNCTION: Load Pending Assignments/Workload List (FIXED BUG)
        async function loadPendingAssignments() {
            const data = await apiCall('/pending-assignments');
            const tbody = document.querySelector('#assignmentsTable tbody');
            tbody.innerHTML = '';

            // Get header elements
            const assignmentsPageHeader = document.getElementById('assignmentsPageHeader');
            const assignmentsPageSubtitle = document.getElementById('assignmentsPageSubtitle');
            const assignmentHeaderTitle = document.getElementById('assignmentHeaderTitle');
            const assignmentHeaderSubject = document.getElementById('assignmentHeaderSubject');

            // Set Headers based on user role
            if (currentUser.type === 'faculty') {
                assignmentsPageHeader.textContent = 'Grading & Pending Workload üìã';
                assignmentsPageSubtitle.textContent = 'Your list of pending tasks to be completed.';
                assignmentHeaderTitle.textContent = 'Task/Item';
                assignmentHeaderSubject.textContent = 'Course/Department';

            } else { // Student
                assignmentsPageHeader.textContent = 'Pending Assignments üìö';
                assignmentsPageSubtitle.textContent = 'Your list of incomplete academic tasks and due dates.';
                assignmentHeaderTitle.textContent = 'Title';
                assignmentHeaderSubject.textContent = 'Subject';
            }


            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No pending items found! üéâ</td></tr>';
                return;
            }

            data.forEach(item => {
                const statusColor = item.status === 'Pending' ? 'var(--danger)' :
                                    item.status === 'Overdue' ? 'var(--danger)' :
                                    'var(--success)';

                // The data structure uses 'subject' and 'title' consistently
                const titleColumn = item.title;
                const subjectColumn = item.subject;

                tbody.innerHTML += `
                    <tr>
                        <td>${subjectColumn}</td>
                        <td>${titleColumn}</td>
                        <td>${item.due_date}</td>
                        <td><span style="font-weight: 600; color: ${statusColor};">${item.status}</span></td>
                    </tr>`;
            });
        }


        async function loadExams() {
            // Backend filters this data based on logged-in user's courses
            const data = await apiCall('/exams');
            const tbody = document.querySelector('#examsTable tbody');
            tbody.innerHTML = data.map(item => `<tr><td>${item.subject}</td><td>${item.date}</td><td>${item.time}</td><td>${item.room}</td><td>${item.duration}</td></tr>`).join('');
        }

        async function loadEvents() {
            const data = await apiCall('/events');
            const container = document.getElementById('eventsContainer');
            container.innerHTML = data.map(event => `
                <div class="event-card">
                    <span class="event-date" style="font-size: 0.8em; padding: 5px 10px; color: var(--text-secondary);">${event.date}</span>
                    <h3 style="font-size: 1.2em; margin: 8px 0; color: var(--text-primary);">${event.title}</h3>
                    <div style="display: flex; gap: 20px; font-size: 0.9em; color: var(--text-secondary);">
                        <span><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: sub; margin-right: 5px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${event.time}</span>
                        <span><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="vertical-align: sub; margin-right: 5px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>${event.location}</span>
                    </div>
                    <p style="margin-top: 10px; color: var(--text-primary);">${event.description}</p>
                </div>`).join('');
             document.getElementById('upcomingEventsCount').textContent = data.length;
        }

        async function loadFaculty() {
            const data = await apiCall('/faculty');
            const tbody = document.querySelector('#facultyTable tbody');
            tbody.innerHTML = data.map(item => `<tr><td>${item.name}</td><td>${item.department}</td><td>${item.email}</td><td>${item.phone}</td><td>${item.office}</td></tr>`).join('');
        }

        async function loadNotifications() {
            const data = await apiCall('/notifications');
            const container = document.getElementById('notificationsContainer');
            const unreadCount = data.filter(n => !n.read).length;
            document.getElementById('notifBadge').textContent = unreadCount;
            document.getElementById('topNotifBadge').textContent = unreadCount;
            container.innerHTML = data.map(n => `
                <div class="notification-item ${!n.read ? 'unread' : ''}" style="padding: 15px; border-bottom: 1px solid var(--card-border);">
                    <div style="font-weight: 600; color: var(--text-primary);">${n.title}</div>
                    <p style="margin: 5px 0; color: var(--text-secondary);">${n.message}</p>
                    <div style="font-size: 0.85em; color: var(--text-secondary);">${n.time}</div>
                </div>`).join('');
        }

        async function loadAnalytics() {
            try {
                const data = await apiCall('/analytics');
                const container = document.getElementById('analyticsGrid');
                container.innerHTML = `
                    <div class="card"><div class="card-header"><div class="card-icon blue"><svg width="24" height="24" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></div><div><div class="card-title">Total Queries</div></div></div><div class="card-value">${data.total_queries}</div></div>
                    <div class="card"><div class="card-header"><div class="card-icon green"><svg width="24" height="24" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></div><div><div class="card-title">Active Students</div></div></div><div class="card-value">${data.active_students}</div></div>
                `;
            } catch(error) {
                console.error("Failed to load analytics:", error);
                const container = document.getElementById('analyticsGrid');
                container.innerHTML = `<p style="color: var(--danger); padding: 20px;">Could not load analytics. Faculty access may be required.</p>`;
            }
        }

        // --- Core Chat Function (Uses Flask/Llama 3.2 backend) ---
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const messagesId = 'chatMessages';
            const message = input.value.trim();
            if (!message) return;

            addMessageToChat(messagesId, message, 'user');
            input.value = '';

            addTypingIndicator(messagesId);

            try {
                // Keeps the original /chat endpoint
                const data = await apiCall('/chat', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });
                removeTypingIndicator();
                addMessageToChat(messagesId, data.response, 'bot');
            } catch (error) {
                 removeTypingIndicator();
                 addMessageToChat(messagesId, 'Sorry, I encountered an error talking to Llama 3.2.', 'bot');
            }
        }

        function addMessageToChat(containerId, text, type) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            const avatarText = type === 'bot' ? 'AI' : currentUser.name.split(' ').map(n => n[0]).join('');
            messageDiv.innerHTML = `<div class="message-avatar">${avatarText}</div><div class="message-content">${text}</div>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function handleEventPost(e) {
            e.preventDefault();
            const eventData = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value
            };

            try {
                const data = await apiCall('/post-event', {
                    method: 'POST',
                    body: JSON.stringify(eventData)
                });
                if (data.success) {
                    showToast('Event posted successfully!', 'success');
                    document.getElementById('eventForm').reset();
                    loadEvents(); // Refresh the events list
                }
            } catch(error) {
                // Error toast is already handled by apiCall
            }
        }


        // --- Doubt Solver Logic (Image and Text) ---

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function isImageFile(extension) {
            return ['jpg', 'jpeg', 'png'].includes(extension);
        }

        function updateFileStatus() {
            const file = documentUpload.files[0];
            fileStatusDiv.classList.remove('hidden', 'file-status-info', 'file-status-warning', 'file-status-success', 'file-status-image');
            documentTextArea.value = ""; // Clear text area on new file selection

            if (file) {
                fileNameSpan.textContent = file.name;
                const extension = getFileExtension(file.name);
                const icon = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ';

                if (extension === 'txt') {
                    fileStatusDiv.classList.add('file-status-success');
                    statusMessageSpan.innerHTML = `${icon} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>TXT file detected. Ready for direct AI processing.</span>`;
                    documentTextArea.placeholder = "Leave this box empty. The content will be read directly from the TXT file.";
                } else if (isImageFile(extension)) {
                    fileStatusDiv.classList.add('file-status-image');
                    statusMessageSpan.innerHTML = `${icon} d="M4 16l4.586-4.586a2 2 0 012.828 0L20 18V5a2 2 0 00-2-2H6a2 2 0 00-2 2v11zM14 11a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Image file detected. Using Gemini Vision Model.</span>`;
                    documentTextArea.placeholder = "Leave this box empty. Document text is NOT required for image files.";
                } else if (extension === 'pdf' || extension === 'docx') {
                    fileStatusDiv.classList.add('file-status-warning');
                    statusMessageSpan.innerHTML = `${icon} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.368 17c-.77 1.333.192 3 1.732 3z"></path></svg><span>Complex file type selected.</span>`;
                    documentTextArea.placeholder = ">>> REQUIRED: Paste the full text content of your PDF/DOCX file here for the AI to analyze. <<<";
                } else {
                    fileStatusDiv.classList.add('file-status-info');
                    statusMessageSpan.innerHTML = `${icon} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Unsupported file type.</span>`;
                    documentTextArea.placeholder = "Unsupported file type selected.";
                }
            } else {
                fileStatusDiv.classList.add('hidden');
            }

            doubtResponseContent.innerHTML = '<p style="color: var(--text-secondary);">Upload a document and ask a question to get context-specific answers from the AI.</p>';
        }

        async function handleDoubtSolverQuery(e) {
            e.preventDefault();
            const file = documentUpload.files[0];
            const query = userQueryInput.value.trim();
            const extension = file ? getFileExtension(file.name) : null;

            if (!file || !query) {
                showToast('Please select a file and enter your question.', 'error');
                return;
            }

            // Setup loading state
            const solveDoubtBtn = document.getElementById('solveDoubtBtn');
            solveDoubtBtn.disabled = true;
            solveDoubtBtn.textContent = 'Processing...';
            doubtResponseContent.innerHTML = '';
            addTypingIndicator('doubtResponseContent', 'bot');

            try {
                // 1. Handle TEXT files (TXT, PDF, DOCX)
                if (extension === 'txt') {
                    await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async function(event) {
                            const payload = { query: query, document_text: event.target.result };
                            await processTextQuery(file.name, payload);
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                    return;

                } else if (extension === 'pdf' || extension === 'docx') {
                    const documentTextManual = documentTextArea.value.trim();
                    if (documentTextManual.length < 50) {
                        throw new Error("For PDF/DOCX, you must paste the document's text into the large text area (min 50 chars).");
                    }
                    const payload = { query: query, document_text: documentTextManual };
                    await processTextQuery(file.name, payload);
                    return;

                // 2. Handle IMAGE files (JPG, PNG, JPEG)
                } else if (isImageFile(extension)) {
                     await new Promise((resolve, reject) => {
                         const reader = new FileReader();
                         reader.onload = async function(event) {
                             const base64Data = event.target.result.split(',')[1];
                             const mimeType = file.type;
                             await processImageQuery(file.name, query, mimeType, base64Data);
                             resolve();
                         };
                         reader.onerror = reject;
                         reader.readAsDataURL(file);
                     });
                     return;
                }

                // Fallback for unsupported types
                throw new Error(`Unsupported file type: ${extension}.`);

            } catch (error) {
                removeTypingIndicator();
                doubtResponseContent.innerHTML = `<p style="color: var(--danger);">An error occurred: ${error.message}</p>`;
                showToast(`Doubt Solver Error: ${error.message}`, 'error');
            } finally {
                solveDoubtBtn.disabled = false;
                solveDoubtBtn.textContent = 'Solve Doubt';
            }
        }

        // --- Exponential Backoff Retry Function ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `Server responded with status: ${response.status}` }));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- Text Document Processing (Uses Ollama/Flask Backend) ---
        async function processTextQuery(fileName, payload) {
            const MAX_TEXT_LENGTH = 15000;
            payload.document_text = payload.document_text.substring(0, MAX_TEXT_LENGTH);

            if (payload.document_text.length === MAX_TEXT_LENGTH) {
                showToast('Document truncated for processing. Max 15,000 characters supported.', 'warning');
            }

            const data = await apiCall('/doubt-solver-query', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            removeTypingIndicator();
            doubtResponseContent.innerHTML = formatResponse(fileName, payload.query, data.summary);
            showToast('Doubt solved successfully!', 'success');
        }


        // --- Image Processing (Uses Gemini API directly - WARNING: Exposed Key) ---
        async function processImageQuery(fileName, query, mimeType, base64Data) {

            const url = GEMINI_API_URL + apiKey;
            const systemPrompt = "You are an expert academic assistant specializing in analyzing images of math problems, diagrams, charts, and handwritten notes. Respond clearly and accurately to the user's request based only on the image content. If the image is illegible or irrelevant, state that clearly.";

            const geminiPayload = {
                contents: [{
                    parts: [
                        { text: query },
                        { inlineData: { mimeType: mimeType, data: base64Data } }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const response = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(geminiPayload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                const responseText = result.candidates[0].content.parts[0].text;
                removeTypingIndicator();
                doubtResponseContent.innerHTML = formatResponse(fileName, query, responseText);
                showToast('Image analyzed successfully!', 'success');
            } else {
                 const errorReason = result.candidates?.[0]?.finishReason || result.promptFeedback?.blockReason || 'Unknown API Error. Check console.';
                 throw new Error(`AI Analysis Failed: ${errorReason}`);
            }
        }

        function formatResponse(fileName, query, responseText) {
            return `
                <p style="font-weight: 600; color: var(--text-primary);">File: ${fileName}</p>
                <p style="font-weight: 600; color: var(--accent-color);">Question: ${query}</p>
                <hr style="margin: 10px 0; border-color: var(--card-border);">
                <div style="white-space: pre-wrap; color: var(--text-primary);">${responseText}</div>
            `;
        }

        // --- Typing Indicator Functions ---

        function addTypingIndicator(containerId, type = 'bot') {
            const container = document.getElementById(containerId);
            const indicatorDiv = document.createElement('div');

            if (containerId === 'chatMessages') {
                indicatorDiv.className = `message ${type}`;
                indicatorDiv.id = 'typing-indicator';
                indicatorDiv.innerHTML = `
                    <div class="message-avatar">AI</div>
                    <div class="message-content" style="display: flex; align-items: center; justify-content: center; width: 60px; height: 40px;">
                        <div class="typing-indicator bot-typing">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
            }
            else if (containerId === 'doubtResponseContent') {
                indicatorDiv.id = 'typing-indicator';
                indicatorDiv.style = "padding: 20px; text-align: center;";
                indicatorDiv.innerHTML = `
                    <p style="font-weight: 600; color: var(--accent-color);">AI is analyzing the document...</p>
                    <div class="typing-indicator bot-typing" style="justify-content: center; margin-top: 10px;">
                        <span></span><span></span><span></span>
                    </div>
                `;
            }

            container.appendChild(indicatorDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        });
    </script>
</body>
</html>
